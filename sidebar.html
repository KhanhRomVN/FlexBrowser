<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>FlexBrowser Sidebar</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #1e1e1e;
      color: #f0f0f0;
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background-color: #252526;
      border-bottom: 1px solid #3c3c3c;
    }

    .tabs-container {
      display: flex;
      background-color: #2d2d2d;
      padding: 8px 8px 0;
      overflow-x: auto;
    }

    .tab-button {
      padding: 8px 16px;
      cursor: pointer;
      background-color: #3c3c3c;
      border-radius: 4px 4px 0 0;
      margin-right: 4px;
      white-space: nowrap;
      font-size: 14px;
      transition: all 0.2s ease;
      position: relative;
    }

    .tab-button:hover {
      background-color: #4a4a4a;
    }

    .tab-button.active {
      background-color: #1e1e1e;
      color: #4ec9b0;
    }

    .tab-button .close {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      background: #ff5f56;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .tab-button:hover .close {
      opacity: 1;
    }

    .controls {
      display: flex;
      gap: 8px;
    }

    .control-btn {
      background: #3c3c3c;
      border: none;
      color: #f0f0f0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .control-btn:hover {
      background: #4a4a4a;
    }

    #webview-container {
      flex: 1;
      position: relative;
      background-color: #1e1e1e;
    }

    webview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      border: none;
    }

    webview.active {
      display: block;
    }

    .url-bar {
      display: flex;
      padding: 8px 16px;
      background-color: #252526;
      border-top: 1px solid #3c3c3c;
    }

    .url-input {
      flex: 1;
      padding: 8px 12px;
      background: #3c3c3c;
      border: 1px solid #0078d4;
      border-radius: 4px;
      color: #f0f0f0;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>FlexBrowser</h2>
    <div class="controls">
      <button class="control-btn" id="new-tab">+</button>
      <button class="control-btn" id="new-incognito">üë§</button>
      <button class="control-btn" id="close-sidebar">‚úï</button>
    </div>
  </div>

  <div class="tabs-container" id="tabs-container"></div>

  <div id="webview-container"></div>

  <div class="url-bar">
    <input type="text" class="url-input" id="url-input" placeholder="Nh·∫≠p URL (v√≠ d·ª•: https://google.com)" />
  </div>

  <script>
    const { ipcRenderer, remote } = require('electron');
    const { session } = remote;
    const sessions = {};
    let activeTabId = null;

    function createTab(isIncognito = false) {
      const tabId = Date.now().toString();
      const partition = isIncognito ? `incognito-${tabId}` : `persist-${tabId}`;
      const sess = isIncognito
        ? session.fromPartition(partition, { cache: false })
        : session.defaultSession;

      sessions[tabId] = {
        partition,
        sess,
        isIncognito,
        url: 'https://google.com'
      };

      const webview = document.createElement('webview');
      const partitionAttr = isIncognito
        ? partition
        : `persist:${partition}`;

      webview.setAttribute('partition', partitionAttr);
      webview.setAttribute('id', `webview-${tabId}`);
      webview.src = 'https://google.com';

      webview.addEventListener('did-finish-load', () => {
        const url = webview.getURL();
        sessions[tabId].url = url;
        if (activeTabId === tabId) {
          document.getElementById('url-input').value = url;
        }
      });

      document.getElementById('webview-container').appendChild(webview);
      addTabButton(tabId, isIncognito);
      switchTab(tabId);

      return tabId;
    }

    function addTabButton(tabId, isIncognito) {
      const tabsContainer = document.getElementById('tabs-container');
      const tabButton = document.createElement('div');

      tabButton.className = 'tab-button';
      tabButton.innerHTML = `
        ${isIncognito ? 'üîí ·∫®n danh' : 'üåê Tab'}
        <div class="close">‚úï</div>
      `;

      tabButton.dataset.tabId = tabId;

      tabButton.addEventListener('click', (e) => {
        if (!e.target.classList.contains('close')) {
          switchTab(tabId);
        }
      });

      tabButton.querySelector('.close').addEventListener('click', () => {
        closeTab(tabId);
      });

      tabsContainer.appendChild(tabButton);
      return tabButton;
    }

    function switchTab(tabId) {
      activeTabId = tabId;

      document.querySelectorAll('webview').forEach(wv => {
        wv.classList.remove('active');
      });

      const activeWebview = document.getElementById(`webview-${tabId}`);
      if (activeWebview) {
        activeWebview.classList.add('active');
        document.getElementById('url-input').value = sessions[tabId].url;
      }

      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tabId === tabId);
      });
    }

    function closeTab(tabId) {
      const webview = document.getElementById(`webview-${tabId}`);
      if (webview) webview.remove();

      const tabButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
      if (tabButton) tabButton.remove();

      delete sessions[tabId];

      const remainingTabs = Object.keys(sessions);
      if (remainingTabs.length > 0) {
        switchTab(remainingTabs[0]);
      } else {
        createTab();
      }
    }

    document.getElementById('url-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && activeTabId) {
        const url = e.target.value.trim();
        if (url) {
          const webview = document.getElementById(`webview-${activeTabId}`);
          if (webview) {
            const fullUrl = url.startsWith('http') ? url : `https://${url}`;
            webview.src = fullUrl;
            sessions[activeTabId].url = fullUrl;
          }
        }
      }
    });

    document.getElementById('new-tab').addEventListener('click', () => {
      createTab(false);
    });

    document.getElementById('new-incognito').addEventListener('click', () => {
      createTab(true);
    });

    document.getElementById('close-sidebar').addEventListener('click', () => {
      ipcRenderer.send('close-sidebar');
    });

    createTab(false);
  </script>
</body>
</html>